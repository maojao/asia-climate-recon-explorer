<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Asia Climate Recon Explorer</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.css">
  <script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

  <style>
    :root { --border:#ddd; --muted:#555; --bg:#fafafa; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#fff; }
    #app { display:flex; flex-direction:column; height:100vh; }

    #topbar {
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      display:flex; flex-wrap:wrap;
      gap:10px 12px; align-items:center;
      background:white; z-index:10;
    }
    .small { font-size:12px; color:var(--muted); }
    select, button, input[type="text"] { padding:6px 8px; }
    button { cursor:pointer; }
    .pill { background:var(--bg); border:1px solid var(--border); border-radius:999px; padding:6px 10px; }
    .helpBtn { border:1px solid var(--border); background:white; border-radius:999px; padding:6px 10px; font-size:12px; }

    #main {
      display:grid;
      grid-template-rows:58vh 42vh;
      height: calc(100vh - 56px);
    }
    #mapWrap { position:relative; border-bottom:1px solid var(--border); }
    #map { height:100%; position:relative; z-index:1; }

    #sidePanel {
      position:absolute; top:12px; right:12px;
      z-index:2000;
      width:340px;
      max-height:calc(100% - 24px);
      overflow:auto;
      background: rgba(255,255,255,0.96);
      border:1px solid var(--border);
      border-radius:14px;
      box-shadow:0 8px 20px rgba(0,0,0,0.08);
      padding:10px;
    }
    #sidePanel h3 { margin:4px 0 8px 0; font-size:14px; }
    .row { display:flex; align-items:center; gap:8px; }
    .grow { flex:1; }
    .swatch { width:10px; height:10px; border-radius:3px; display:inline-block; }
    .siteItem { padding:8px 8px; border:1px solid var(--border); border-radius:12px; margin-bottom:8px; background:white; }
    .siteItem.highlight { outline:2px solid #222; outline-offset:2px; }
    .siteItem.pinned { box-shadow: inset 0 0 0 2px #222; }
    .siteName { font-weight:600; font-size:13px; }
    .siteMeta { font-size:12px; color:var(--muted); margin-top:2px; }
    .legendHint { font-size:12px; color:var(--muted); margin:2px 0 8px 0; }
    .dragHandle { cursor: grab; user-select:none; padding: 2px 6px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); }
    .iconBtn { border: 1px solid var(--border); background: white; border-radius: 10px; padding: 4px 8px; }
    .iconBtn.on { border-color:#222; }

    #plotToolbar {
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      display:flex; flex-wrap:wrap;
      gap:10px 12px; align-items:center;
      background:#fff;
    }
    #plot { height: calc(42vh - 52px); }
    #ageSlider { width:240px; margin:2px 6px; }

    /* Dropdown menus */
    .dropdown { position: relative; display: inline-flex; align-items: center; }
    .menu {
      position: absolute;
      top: calc(100% + 6px);
      left: 0;
      min-width: 220px;
      background: white;
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 12px 24px rgba(0,0,0,0.12);
      padding: 6px;
      display: none;
      z-index: 5000;
    }
    .menu.right { left: auto; right: 0; }
    .menuItem {
      width: 100%;
      text-align: left;
      border: 0;
      background: transparent;
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 13px;
      cursor: pointer;
    }
    .menuItem:hover { background: #f3f3f3; }
    .menuLabel { font-size: 11px; color: var(--muted); padding: 6px 10px 2px 10px; }
    .menuDivider { height: 1px; background: var(--border); margin: 6px 4px; }
    .menuRow { display:flex; gap:8px; padding: 6px 10px; align-items:center; flex-wrap:wrap; }
    .chip { border: 1px solid var(--border); background: #fff; border-radius: 999px; padding: 4px 8px; font-size: 12px; cursor:pointer; }
    .chip:hover { background:#f3f3f3; }

    /* Overlays */
    .overlay {
      position:fixed; inset:0;
      background:rgba(0,0,0,0.45);
      display:none; align-items:center; justify-content:center;
      z-index:9999;
    }
    .modal {
      width: min(860px, 94vw);
      max-height: 88vh;
      overflow:auto;
      background:white;
      border-radius:16px;
      padding:18px 20px;
      box-shadow:0 20px 40px rgba(0,0,0,0.25);
    }
    .modal h2 { margin: 0 0 8px 0; }
    .modal h3 { margin: 14px 0 6px 0; }
    .modal p, .modal li { font-size:14px; line-height:1.55; }
    .modal .closeBtn { float:right; border:1px solid var(--border); background:white; border-radius:10px; padding:4px 10px; }
    .modal .kicker { font-size:12px; color:var(--muted); margin-bottom:10px; }
    .callout { background: #f7f7f7; border: 1px solid var(--border); border-radius: 12px; padding: 10px 12px; }
    .twoCol { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 900px) { .twoCol { grid-template-columns: 1fr; } }

    @media (max-width: 900px) {
      #sidePanel { width:92vw; left:12px; right:12px; }
      #ageSlider { width:180px; }
      #main { grid-template-rows:54vh 46vh; }
    }
  </style>
</head>

<body>
<div id="app">
  <div id="topbar">
    <span class="pill small">Asia Climate Recon Explorer</span>

    <label class="small">Lang</label>
    <select id="langSelect">
      <option value="en" selected>EN</option>
      <option value="ko" >ÌïúÍµ≠Ïñ¥</option>
    </select>

    <div class="dropdown" id="helpDropdown">
      <button class="helpBtn" id="helpBtn">Help ‚ñæ</button>
      <div class="menu" id="helpMenu">
        <button class="menuItem" id="welcomeOpen">Welcome</button>
        <button class="menuItem" id="varOpen">Variables</button>
        <button class="menuItem" id="methodOpen">MAT vs WA-PLS</button>
        <button class="menuItem" id="aboutOpen">About dataset</button>
      </div>
    </div>

    <label class="small">Basemap</label>
    <select id="baseSelect">
      <option value="osm" selected>OSM</option>
      <option value="carto">Carto Light</option>
    </select>

    <label class="small">Hillshade</label>
    <select id="hsSource">
      <option value="wmf" selected>WMF</option>
      <option value="esri">ESRI</option>
      <option value="off">Off</option>
    </select>
    <input id="hsOpacity" type="range" min="0" max="100" value="45" />
    <span class="small" id="hsLabel">45%</span>
    <span class="small" id="hsStatus"></span>

    <span class="pill small" id="selInfo">Selected: 0</span>
    <input id="searchBox" type="text" placeholder="Search selected sites" style="min-width:220px;" />
    <button id="clearBtn">Clear</button>
  </div>

  <div id="main">
    <div id="mapWrap">
      <div id="map"></div>
      <div id="sidePanel">
        <div class="row" style="justify-content:space-between;">
          <h3>Selected sites</h3>
          <span class="small" id="pointsInfo"></span>
        </div>
        <div class="legendHint">‚Ä¢ Drag ‚Üï to reorder (plot follows) ¬∑ Solid=WA‚ÄëPLS ¬∑ Dashed=MAT ¬∑ üìå pinned</div>
        <div id="selectedList"></div>
      </div>
    </div>

    <div>
      <div id="plotToolbar">
        <label class="small">Variable</label>
        <select id="groupSelect"></select>

        <label class="small">Method</label>
        <label class="small"><input type="checkbox" id="mWapls" checked> WA‚ÄëPLS</label>
        <label class="small"><input type="checkbox" id="mMat" checked> MAT</label>

        <label class="small">Age axis</label>
        <select id="ageSelect">
          <option value="mean" selected>mean</option>
          <option value="median">median</option>
        </select>

        <span class="pill small">Age range</span>
        <div id="ageSlider"></div>
        <span class="small" id="ageReadout"></span>

        <div class="dropdown" id="exportDropdown">
          <button class="helpBtn" id="exportBtn">Export ‚ñæ</button>
          <div class="menu right" id="exportMenu">
            <div class="menuLabel">Mode</div>
            <div class="menuRow">
              <label class="small"><input type="radio" name="exportMode" value="view" checked> current view</label>
              <label class="small"><input type="radio" name="exportMode" value="full"> full series</label>
            </div>
            <div class="menuDivider"></div>
            <div class="menuLabel">Download</div>
            <div class="menuRow">
              <button class="chip" id="exportPng">PNG</button>
              <button class="chip" id="exportSvg">SVG</button>
              <button class="chip" id="exportCsv">CSV</button>
            </div>
          </div>
        </div>
      </div>
      <div id="plot"></div>
    </div>
  </div>
</div>

<!-- Overlays -->
<div class="overlay" id="welcomeOverlay"><div class="modal">
  <button class="closeBtn" onclick="closeOverlay('welcomeOverlay', true)">Close</button>
  <h2>Welcome</h2>
  <div class="kicker">Shown only once per device/browser.</div>
  
<ul>
<li>Click markers to select multiple sites.</li>
<li>Solid line = WA‚ÄëPLS, dashed = MAT.</li>
<li>Use the age slider to focus on a time window.</li>
<li>Use Help ‚ñæ for variable/method explanations and dataset structure.</li>
</ul>
<div class="callout">
<b>How to cite</b><br>
Dataset (PANGAEA): <a href="https://doi.org/10.1594/PANGAEA.930512" target="_blank" rel="noopener">10.1594/PANGAEA.930512</a><br>
Paper (ESSD): <a href="https://doi.org/10.5194/essd-15-2235-2023" target="_blank" rel="noopener">10.5194/essd-15-2235-2023</a><br>
Code (Zenodo): <a href="https://doi.org/10.5281/zenodo.7887565" target="_blank" rel="noopener">10.5281/zenodo.7887565</a>
</div>

</div></div>

<div class="overlay" id="varOverlay"><div class="modal">
  <button class="closeBtn" onclick="closeOverlay('varOverlay', false)">Close</button>
  <h2>Variables</h2>
  
<h3>Climate variables</h3>
<ul>
<li><b>MAAT (¬∞C)</b>: Mean Annual Air Temperature.</li>
<li><b>July T (¬∞C)</b>: Mean July air temperature.</li>
<li><b>Pann (mm/a)</b>: Annual total precipitation.</li>
</ul>
<h3>Diagnostics (reliability)</h3>
<ul>
<li><b>MinDC</b>: minimum dissimilarity to modern analogues (lower is typically better).</li>
<li><b>DSML</b>: dissimilarity metric (higher can indicate weaker analogue support).</li>
</ul>

</div></div>

<div class="overlay" id="methodOverlay"><div class="modal">
  <button class="closeBtn" onclick="closeOverlay('methodOverlay', false)">Close</button>
  <h2>MAT vs WA‚ÄëPLS</h2>
  
<div class="twoCol">
<div class="callout">
<h3>MAT</h3>
<p>Find the most similar modern pollen samples (‚Äúmodern analogues‚Äù) and use their climate values to estimate the past.</p>
<ul><li>Conservative and intuitive</li><li>Can be noisy if no good modern analogue exists</li></ul>
</div>
<div class="callout">
<h3>WA‚ÄëPLS</h3>
<p>Regression-based method that learns proxy‚Äìclimate relationships from modern calibration data; often smoother and robust to noise.</p>
<ul><li>Good long-term trends</li><li>More model-dependent</li></ul>
</div>
</div>
<p><b>Tip:</b> Agreement between MAT and WA‚ÄëPLS suggests more robust signals.</p>

</div></div>

<div class="overlay" id="aboutOverlay"><div class="modal">
  <button class="closeBtn" onclick="closeOverlay('aboutOverlay', false)">Close</button>
  <h2>About dataset</h2>
  
<p>LegacyClimate 1.0 is split into multiple files to separate primary reconstructions from expert assessment layers.</p>
<ul>
<li><b>climate-recons_Asia.tab</b> (used here): primary reconstructions per sample (MAAT/July T/Pann) with MAT & WA‚ÄëPLS.</li>
<li><b>climate-recons-model-stats_Asia.tab</b>: model performance/metadata (RMSEP, r¬≤, etc.).</li>
<li><b>climate-recons-signif_Asia.tab</b>: significance test results (caution layer).</li>
</ul>
<h3>Age axis: mean vs median</h3>
<ul>
<li><b>mean</b>: arithmetic mean age.</li>
<li><b>median</b>: 50th percentile age (more robust for skewed age distributions).</li>
</ul>
<h3>Credits</h3>
<div class="callout">
Viewer created by: Yeongcheol Han (Korea Polar Research Institute) ‚Äî <a href="mailto:yhan@kopri.re.kr">yhan@kopri.re.kr</a><br>
Developed with assistance from generative AI (ChatGPT) for code structuring and documentation.
</div>

</div></div>

<script>
function openOverlay(id){ document.getElementById(id).style.display='flex'; }
function closeOverlay(id, markWelcomeSeen){
  document.getElementById(id).style.display='none';
  if (markWelcomeSeen) localStorage.setItem('acrex_welcome_seen','1');
}
function toggleMenu(menuId) {
  const menu = document.getElementById(menuId);
  const isOpen = menu.style.display === 'block';
  document.querySelectorAll('.menu').forEach(m => m.style.display='none');
  menu.style.display = isOpen ? 'none' : 'block';
}
function closeAllMenus() {
  document.querySelectorAll('.menu').forEach(m => m.style.display='none');
}
document.addEventListener('click', (e) => {
  const dd = e.target.closest('.dropdown');
  if (!dd) closeAllMenus();
});
</script>

<script>
(async function() {
  const data = await (await fetch('./sites.json')).json();
  const sites = data.sites;
  const variables = data.variables;

  // one-time welcome
  if (!localStorage.getItem('acrex_welcome_seen')) openOverlay('welcomeOverlay');

  // language switch
  const langSelect = document.getElementById('langSelect');
  langSelect.addEventListener('change', () => {
    const v = langSelect.value;
    try { localStorage.setItem('acrex_lang_pref', v); } catch(e) {}
    window.location.href = (v==='ko') ? 'index_ko.html' : 'index_en.html';
  });

  // help menu
  document.getElementById('helpBtn').addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); toggleMenu('helpMenu'); });
  document.getElementById('exportBtn').addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); toggleMenu('exportMenu'); });

  const map = L.map('map', { worldCopyJump:true }).setView([40,90],3);
  const baseLayers = {
    osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:18, attribution:'&copy; OpenStreetMap' }),
    carto: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom:18, attribution:'&copy; OpenStreetMap & Carto' })
  };
  baseLayers.osm.addTo(map);

  const hsOpacity = document.getElementById('hsOpacity');
  const hsLabel = document.getElementById('hsLabel');
  const hsStatus = document.getElementById('hsStatus');
  const hillshadeWMF = L.tileLayer('https://tiles.wmflabs.org/hillshading/{z}/{x}/{y}.png', { maxZoom:18, opacity:0.45, attribution:'Hillshade (WMF)' });
  const hillshadeESRI = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Elevation/World_Hillshade/MapServer/tile/{z}/{y}/{x}', { maxZoom:18, opacity:0.45, attribution:'Hillshade (ESRI)' });
  function attach(layer) {
    layer.on('tileerror', ()=>{ hsStatus.textContent=' (not loading)'; });
    layer.on('load', ()=>{ hsStatus.textContent=''; });
  }
  attach(hillshadeWMF); attach(hillshadeESRI);
  let hillshade = hillshadeWMF.addTo(map);

  function setHillshadeSource(val) {
    if (hillshade) map.removeLayer(hillshade);
    hsStatus.textContent='';
    if (val==='off') { hillshade=null; return; }
    hillshade = (val==='esri') ? hillshadeESRI : hillshadeWMF;
    hillshade.setOpacity(Number(hsOpacity.value)/100);
    hillshade.addTo(map);
    hillshade.bringToFront();
  }
  document.getElementById('hsSource').addEventListener('change', (e)=> setHillshadeSource(e.target.value));
  document.getElementById('baseSelect').addEventListener('change', (e)=>{
    Object.values(baseLayers).forEach(l=> map.removeLayer(l));
    baseLayers[e.target.value].addTo(map);
    if (hillshade) hillshade.bringToFront();
  });
  hsOpacity.addEventListener('input', ()=>{
    if (hillshade) hillshade.setOpacity(Number(hsOpacity.value)/100);
    hsLabel.textContent = `${hsOpacity.value}%`;
  });

  // variable groups
  function parseVar(v) {
    const parts = v.label.split(' - ');
    return { key:v.key, label:v.label, group:parts[0].trim(), method:(parts[1]||'').trim() };
  }
  const parsedVars = variables.map(parseVar);
  const groups = Array.from(new Set(parsedVars.map(v=>v.group))).sort((a,b)=>a.localeCompare(b));
  const groupSelect = document.getElementById('groupSelect');
  groups.forEach(g=>{ const o=document.createElement('option'); o.value=g; o.textContent=g; groupSelect.appendChild(o); });
  const preferred = ['MAAT (¬∞C)','July T (¬∞C)','Pann (mm/a)'];
  groupSelect.value = preferred.find(p=>groups.includes(p)) || groups[0];

  // plot
  Plotly.newPlot('plot', [{x:[],y:[],mode:'lines+markers',name:'select a site'}], {
    margin:{l:60,r:15,t:20,b:50},
    xaxis:{title:'Age (ka BP)', autorange:'reversed'},
    yaxis:{title:'Value'},
    legend:{orientation:'h'}
  }, {responsive:true});

  // slider
  const ageSelect = document.getElementById('ageSelect');
  const sliderEl = document.getElementById('ageSlider');
  const ageReadout = document.getElementById('ageReadout');
  function computeAgeMinMax(axis) {
    let mn=Infinity, mx=-Infinity;
    for (const s of sites) {
      const arr = (axis==='median') ? (s.age_median_ka_bp||[]) : (s.age_mean_ka_bp||[]);
      for (const v of arr) { if (typeof v==='number' && isFinite(v)) { mn=Math.min(mn,v); mx=Math.max(mx,v); } }
    }
    if (!isFinite(mn)||!isFinite(mx)) return [0,100];
    return [mn,mx];
  }
  let [globalMin, globalMax] = computeAgeMinMax('mean');
  noUiSlider.create(sliderEl, { start:[globalMin,globalMax], connect:true, step:0.1, range:{min:globalMin,max:globalMax} });
  function getAgeWindow() {
    const vals = sliderEl.noUiSlider.get().map(x=>Number(x));
    return [Math.min(vals[0],vals[1]), Math.max(vals[0],vals[1])];
  }
  sliderEl.noUiSlider.on('update', ()=>{
    const [a0,a1]=getAgeWindow();
    ageReadout.textContent = `${a0.toFixed(1)} ‚Äì ${a1.toFixed(1)} ka BP`;
  });
  sliderEl.noUiSlider.on('set', ()=> updatePlot());
  function resetSliderForAxis(axis) {
    const [mn,mx]=computeAgeMinMax(axis);
    const [cur0,cur1]=getAgeWindow();
    sliderEl.noUiSlider.updateOptions({ range:{min:mn,max:mx} }, false);
    sliderEl.noUiSlider.set([Math.max(mn,Math.min(mx,cur0)), Math.max(mn,Math.min(mx,cur1))]);
  }

  // selection
  const selected = new Map();
  const selectedOrder = [];
  const pinned = new Set();
  let highlightId = null;
  const colorway = ["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"];
  function nextColor(){ return colorway[selected.size % colorway.length]; }
  function setMarkerStyle(m,isOn,color){ if (isOn) m.setStyle({radius:8,weight:2,fillOpacity:1.0,color,fillColor:color}); else m.setStyle({radius:5,weight:1,fillOpacity:0.85}); }
  function getAgeArray(site){ return (ageSelect.value==='median') ? (site.age_median_ka_bp||[]) : (site.age_mean_ka_bp||[]); }
  function popupHtml(s) {
    return `<div style="min-width:230px"><b>${s.name}</b><br><span class="small">ID:</span> ${s.site_id}<br><span class="small">Lat/Lon:</span> ${s.lat.toFixed(4)}, ${s.lon.toFixed(4)}<br><span class="small">Points:</span> ${getAgeArray(s).length}</div>`;
  }

  const cluster = L.markerClusterGroup({ showCoverageOnHover:false });
  map.addLayer(cluster);

  for (const s of sites) {
    const id = String(s.site_id);
    const m = L.circleMarker([s.lat,s.lon], {radius:5,weight:1,fillOpacity:0.85});
    m.on('click', ()=> toggleSelect(id,s,m));
    cluster.addLayer(m);
  }

  function toggleSelect(id, site, marker) {
    if (selected.has(id)) {
      const obj = selected.get(id);
      selected.delete(id);
      setMarkerStyle(marker,false);
      marker.closePopup();
      const idx = selectedOrder.indexOf(id);
      if (idx>=0) selectedOrder.splice(idx,1);
      pinned.delete(id);
      if (highlightId===id) highlightId=null;
    } else {
      const color = nextColor();
      selected.set(id, {site, marker, color});
      setMarkerStyle(marker,true,color);
      marker.bindPopup(popupHtml(site), {autoPan:true, autoPanPaddingTopLeft:[10,10], autoPanPaddingBottomRight:[360,10]}).openPopup();
      selectedOrder.push(id);
      highlightId=id;
    }
    updateSelectedList();
    updatePlot();
  }

  const selInfo = document.getElementById('selInfo');
  const pointsInfo = document.getElementById('pointsInfo');
  const selectedList = document.getElementById('selectedList');
  const searchBox = document.getElementById('searchBox');

  function entriesFiltered() {
    const q=(searchBox.value||'').toLowerCase().trim();
    const ids=selectedOrder.filter(id=>selected.has(id));
    const out=[];
    for (const id of ids) {
      const obj=selected.get(id);
      if (q && !String(obj.site.name||'').toLowerCase().includes(q)) continue;
      out.push({id, ...obj});
    }
    return out;
  }

  function updateSelectedList() {
    const entries = entriesFiltered();
    selectedList.innerHTML='';
    for (const e of entries) {
      const isPinned = pinned.has(e.id);
      const div=document.createElement('div');
      div.className='siteItem'+(highlightId===e.id?' highlight':'')+(isPinned?' pinned':'');
      div.setAttribute('data-id', e.id);
      div.innerHTML = `
        <div class="row">
          <span class="dragHandle">‚Üï</span>
          <label class="grow" style="display:flex; align-items:center; gap:8px;">
            <input type="checkbox" checked data-id="${e.id}">
            <span class="swatch" style="background:${e.color}"></span>
            <span class="siteName">${e.site.name}</span>
          </label>
          <button class="iconBtn ${isPinned?'on':''}" data-pin="${e.id}">üìå</button>
          <button class="iconBtn small" data-zoom="${e.id}">Zoom</button>
        </div>
        <div class="siteMeta">ID:${e.site.site_id} ¬∑ ${e.site.lat.toFixed(3)}, ${e.site.lon.toFixed(3)}</div>`;
      div.addEventListener('click',(ev)=>{
        const tag=(ev.target && ev.target.tagName)?ev.target.tagName.toLowerCase():'';
        if (tag==='input' || tag==='button') return;
        highlightId=e.id; updateSelectedList(); updatePlot();
      });
      selectedList.appendChild(div);
    }
    // checkbox remove
    selectedList.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
      cb.addEventListener('change',(ev)=>{
        const id=ev.target.getAttribute('data-id');
        if (!selected.has(id)) return;
        const obj=selected.get(id);
        selected.delete(id);
        setMarkerStyle(obj.marker,false);
        obj.marker.closePopup();
        const idx=selectedOrder.indexOf(id); if (idx>=0) selectedOrder.splice(idx,1);
        pinned.delete(id);
        if (highlightId===id) highlightId=null;
        updateSelectedList(); updatePlot();
      });
    });
    // pin
    selectedList.querySelectorAll('button[data-pin]').forEach(btn=>{
      btn.addEventListener('click',(ev)=>{
        ev.stopPropagation();
        const id=ev.target.getAttribute('data-pin');
        if (pinned.has(id)) pinned.delete(id); else pinned.add(id);
        updateSelectedList(); updatePlot();
      });
    });
    // zoom
    selectedList.querySelectorAll('button[data-zoom]').forEach(btn=>{
      btn.addEventListener('click',(ev)=>{
        ev.stopPropagation();
        const id=ev.target.getAttribute('data-zoom');
        const obj=selected.get(id); if (!obj) return;
        highlightId=id;
        map.setView([obj.site.lat,obj.site.lon], 7, {animate:true});
        setTimeout(()=>{ map.panBy([-220,0], {animate:true}); obj.marker.openPopup(); }, 250);
        updateSelectedList(); updatePlot();
      });
    });
    selInfo.textContent = `Selected: ${selected.size}`;
    const totalPts = Array.from(selected.values()).reduce((acc,o)=>acc + (getAgeArray(o.site).length), 0);
    pointsInfo.textContent = selected.size ? `Total points: ${totalPts}` : '';
  }

  document.getElementById('clearBtn').addEventListener('click',()=>{
    for (const [id,obj] of selected.entries()) { setMarkerStyle(obj.marker,false); obj.marker.closePopup(); }
    selected.clear(); selectedOrder.splice(0,selectedOrder.length); pinned.clear(); highlightId=null;
    updateSelectedList(); updatePlot();
  });
  searchBox.addEventListener('input', updateSelectedList);
  new Sortable(selectedList, {
    animation:120, handle:'.dragHandle',
    onEnd: ()=>{
      const domIds = Array.from(selectedList.querySelectorAll('.siteItem')).map(el=>el.getAttribute('data-id'));
      const hidden = selectedOrder.filter(id=>selected.has(id) && !domIds.includes(id));
      selectedOrder.splice(0,selectedOrder.length, ...domIds, ...hidden);
      updatePlot();
    }
  });

  // helpers for plotting
  function activeVarKeys() {
    const group=groupSelect.value;
    const out=[];
    parsedVars.forEach(v=>{
      if (v.group!==group) return;
      if (v.method==='WA-PLS' && document.getElementById('mWapls').checked) out.push(v.key);
      if (v.method==='MAT' && document.getElementById('mMat').checked) out.push(v.key);
      if (!v.method) out.push(v.key);
    });
    return out;
  }
  function methodForKey(key) {
    const v=parsedVars.find(x=>x.key===key);
    return (v && v.method) ? v.method : 'series';
  }
  function filterPairs(x,y,minA,maxA,mode) {
    const xf=[], yf=[];
    for (let i=0;i<Math.min(x.length,y.length);i++) {
      const xv=x[i], yv=y[i];
      if (xv==null||yv==null) continue;
      if (typeof xv!=='number'||typeof yv!=='number') continue;
      if (!isFinite(xv)||!isFinite(yv)) continue;
      if (mode==='view' && (xv<minA || xv>maxA)) continue;
      xf.push(xv); yf.push(yv);
    }
    return {x:xf,y:yf};
  }

  function updatePlot() {
    const [minA,maxA]=getAgeWindow();
    const keys=activeVarKeys();
    const group=groupSelect.value;

    const traces=[];
    const ids = selectedOrder.filter(id=>selected.has(id));
    for (const id of ids) {
      const obj=selected.get(id);
      const s=obj.site;
      const color=obj.color;
      const xRaw=getAgeArray(s);
      const isPinned=pinned.has(id);
      const isHi=(highlightId===id);
      const lineW = isHi?5:(isPinned?4:2);
      const mSize = isHi?9:(isPinned?8:6);
      let legendShown=false;

      for (const key of keys) {
        const yRaw=(s.series && s.series[key]) ? s.series[key] : [];
        const filtered=filterPairs(xRaw,yRaw,minA,maxA,'view');
        const method=methodForKey(key);
        const dash = (method==='MAT') ? 'dash' : 'solid';

        traces.push({
          x: filtered.x,
          y: filtered.y,
          mode:'lines+markers',
          name: s.name,
          legendgroup: id,
          showlegend: !legendShown,
          line: {color:color,width:lineW,dash:dash},
          marker: {color:color,size:mSize},
          hovertemplate: '%{x:.2f} ka BP<br>%{y:.3f}<extra>'+s.name+' ¬∑ '+method+'</extra>'
        });
        legendShown=true;
      }
    }
    if (traces.length===0) traces.push({x:[],y:[],mode:'lines+markers',name:'select a site'});

    Plotly.react('plot', traces, {
      margin:{l:60,r:15,t:20,b:50},
      xaxis:{title:`Age (ka BP) ‚Äî ${ageSelect.value}`, autorange:'reversed'},
      yaxis:{title:group},
      legend:{orientation:'h'}
    }, {responsive:true});
  }

  // plot click highlight
  document.getElementById('plot').on('plotly_click',(ev)=>{
    if (!ev || !ev.points || !ev.points.length) return;
    const lg = ev.points[0].data && ev.points[0].data.legendgroup;
    if (lg && selected.has(lg)) {
      highlightId=lg; updateSelectedList(); updatePlot();
    }
  });

  // control events
  groupSelect.addEventListener('change', updatePlot);
  document.getElementById('mWapls').addEventListener('change', updatePlot);
  document.getElementById('mMat').addEventListener('change', updatePlot);
  ageSelect.addEventListener('change', ()=>{ resetSliderForAxis(ageSelect.value); updatePlot(); });

  // Export actions (in Export ‚ñæ)
  document.getElementById('exportPng').addEventListener('click', async ()=>{ closeAllMenus(); await Plotly.downloadImage('plot', {format:'png', filename:'climate_recon_plot'}); });
  document.getElementById('exportSvg').addEventListener('click', async ()=>{ closeAllMenus(); await Plotly.downloadImage('plot', {format:'svg', filename:'climate_recon_plot'}); });

  function downloadText(filename, text) {
    const blob = new Blob([text], {type:'text/csv;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url; a.download=filename;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }
  document.getElementById('exportCsv').addEventListener('click', ()=>{
    closeAllMenus();
    const mode = document.querySelector('input[name="exportMode"]:checked').value; // view|full
    const [minA,maxA]=getAgeWindow();
    const keys=activeVarKeys();
    const group=groupSelect.value;
    const axis=ageSelect.value;
    const header = ['site_id','site_name','method','variable_group','age_axis','export_mode','age_window_min_ka','age_window_max_ka','age_ka_bp','value'].join(',');
    const lines=[header];
    const ids=selectedOrder.filter(id=>selected.has(id));
    for (const id of ids) {
      const obj=selected.get(id);
      const s=obj.site;
      const xRaw=getAgeArray(s);
      for (const key of keys) {
        const method=methodForKey(key);
        const yRaw=(s.series && s.series[key]) ? s.series[key] : [];
        const filtered=filterPairs(xRaw,yRaw,minA,maxA,mode);
        for (let i=0;i<filtered.x.length;i++) {
          const age=filtered.x[i], val=filtered.y[i];
          const name='"'+String(s.name).replaceAll('"','""')+'"';
          lines.push([
            String(s.site_id),
            name,
            method,
            '"'+group.replaceAll('"','""')+'"',
            axis,
            mode,
            minA.toFixed(6),
            maxA.toFixed(6),
            age.toFixed(6),
            val.toFixed(6)
          ].join(','));
        }
      }
    }
    const safe = group.replaceAll(/[^\w\-]+/g,'_');
    downloadText(`selected_${safe}_${axis}_${mode}_${minA.toFixed(1)}-${maxA.toFixed(1)}ka.csv`, lines.join('\n'));
  });

  // Help menu items -> overlays
  function bindOpen(btnId, overlayId) {
    document.getElementById(btnId).addEventListener('click', ()=>{ closeAllMenus(); openOverlay(overlayId); });
  }
  bindOpen('welcomeOpen','welcomeOverlay');
  bindOpen('varOpen','varOverlay');
  bindOpen('methodOpen','methodOverlay');
  bindOpen('aboutOpen','aboutOverlay');

  // init
  updateSelectedList();
  sliderEl.noUiSlider.set([globalMin,globalMax]);
  updatePlot();

})();
</script>
</body>
</html>
